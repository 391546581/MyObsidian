# 基础镜像：指定官方 Flutter 3.19.6 稳定版
FROM ghcr.io/cirruslabs/flutter:3.19.6

# 设置工作目录
WORKDIR /home/flutter

# 1. 更新包管理器并安装 OpenJDK 17
# 同时清理 apt 缓存以减小镜像体积
RUN apt-get update && \
    apt-get install -y openjdk-17-jdk && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 2. 配置 Java 和 Flutter 环境变量
ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
ENV PATH="$JAVA_HOME/bin:$PATH"

# 3. (可选) 指定 Android 编译 SDK 版本
# 这样可以避免构建时提示你接受 licenses
ENV ANDROID_SDK_ROOT=/opt/android-sdk

# 4. 配置 Flutter 国内镜像源
# 这一步对于云效（国内环境）非常重要，能极大提升 pub get 的速度
ENV PUB_HOSTED_URL=https://pub.flutter-io.cn
ENV FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn

# 5. 预运行 flutter doctor 预热
# 同时接受 Android licenses (非交互式，防止云效构建卡住)
RUN flutter doctor -v && \
    yes | flutter doctor --android-licenses

# 6. 验证最终环境
RUN echo "=== Environment Check ===" && \
    echo "Flutter Version:" && \
    flutter --version && \
    echo "Java Version:" && \
    java -version

# 默认命令
CMD ["/bin/bash"]

